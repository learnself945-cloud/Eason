<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è¶…äººæˆé•·å¤§å†’éšª v62</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #b08968; --secondary: #e6ccb2; --accent: #7f5539; 
            --bg: #f5ebe0; --card: #ffffff; --success: #9c6644; 
            --gold: #ddb892; --text: #432818;
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            font-family: "PingFang TC", "STHeitiTC-Light", "Microsoft JhengHei", sans-serif; 
            background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; justify-content: center; 
        }
        .app-card { width: 100%; max-width: 600px; background: var(--card); border-radius: 35px; box-shadow: 0 10px 30px rgba(67,40,24,0.08); padding: 20px; min-height: 92vh; }
        
        .main-score { background: linear-gradient(135deg, var(--accent), var(--primary)); color: #fff; padding: 25px; border-radius: 28px; text-align: center; margin-bottom: 20px; }
        .main-score span { font-size: 3.5em; font-weight: 800; display: block; margin-top: 5px; }
        
        /* é ‚éƒ¨å·¥å…·æ¬„æ¨£å¼ */
        .system-toolbar { display: flex; gap: 8px; margin-bottom: 20px; }
        .btn-tool { flex: 1; padding: 10px 5px; border-radius: 15px; border: 1.5px solid var(--accent); background: white; color: var(--accent); font-weight: bold; cursor: pointer; font-size: 0.8em; }
        .btn-tool.active { background: #fde2e4; border-color: #f08080; color: #d00000; }
        .btn-tool:active { transform: scale(0.98); }

        .date-navigator { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: #ede0d4; border-radius: 12px; padding: 5px 15px; }
        .nav-arrow { font-size: 1.5em; color: var(--accent); cursor: pointer; user-select: none; padding: 5px 10px; }
        .day-label { font-size: 1.1em; font-weight: bold; color: var(--accent); }
        .is-not-today { color: #b08968; font-size: 0.8em; cursor: pointer; }

        .habit-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 10px; border-bottom: 1px solid #fcf2e8; }
        .drag-handle { cursor: grab; color: #b08968; padding-right: 15px; font-size: 1.3em; user-select: none; }
        .habit-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .habit-name { font-size: 1.1em; font-weight: 600; color: var(--accent); cursor: pointer; }
        .habit-name.checked { color: #bb9457; text-decoration: line-through; opacity: 0.6; }

        .quick-add { background: #faf3e0; padding: 18px; border-radius: 22px; margin: 20px 0 12px 0; border: 1px solid #ede0d4; }
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        select, input { padding: 12px; border: 1.5px solid #ede0d4; border-radius: 14px; font-size: 15px; outline: none; }

        .btn-done { background: var(--success); color: white; border: none; padding: 10px 18px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 16px; font-weight: bold; cursor: pointer; }
        .btn-undo { background: #ede0d4; color: var(--accent); }
        .btn-redeem { background: var(--gold); color: #432818; }

        .admin-panel { display: none; background: #fdfaf7; padding: 20px; border-radius: 20px; margin-top: 15px; border: 1px solid #ede0d4; }
        .bank-item { background: white; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 12px; text-align: left; }
        .day-chip { display: inline-block; padding: 4px 8px; font-size: 0.8em; background: #eee; border-radius: 8px; margin-right: 4px; color: #999; cursor: pointer; }
        .day-chip.active { background: var(--accent); color: white; }
        
        .report-section { margin-top: 25px; background: #fff; padding: 10px; border-radius: 22px; border: 1.5px solid #ede0d4; overflow-x: auto; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.85em; text-align: center; min-width: 450px; }
        .report-table td { padding: 10px 0; border-bottom: 1px solid #fcf2e8; }
        .count-badge { background: var(--gold); color: var(--text); padding: 2px 8px; border-radius: 10px; font-weight: bold; }

        .danger-zone { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-secondary-outline { width: 100%; padding: 8px; background: none; border: 1px solid #ccc; color: #999; border-radius: 10px; font-size: 0.85em; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="main-score">
        <div>COIN WALLET</div>
        <span id="totalWallet">0</span>
    </div>

    <div class="system-toolbar">
        <button class="btn-tool" onclick="exportData()">ğŸ“¤ åŒ¯å‡º</button>
        <button class="btn-tool" onclick="importData()">ğŸ“¥ åŒ¯å…¥</button>
        <button id="unlockBtn" class="btn-tool" onclick="handleUnlockToggle()">ğŸ”“ ç·¨è¼¯</button>
    </div>

    <div class="date-navigator">
        <div class="nav-arrow" onclick="changeViewDate(-1)">â—€</div>
        <div style="text-align:center">
            <div class="day-label" id="dateDisplay">è¼‰å…¥ä¸­...</div>
            <div id="todayIndicator" class="is-not-today" style="display:none">(é»æ­¤å›ä»Šå¤©)</div>
        </div>
        <div class="nav-arrow" onclick="changeViewDate(1)">â–¶</div>
    </div>

    <div id="habitList"></div>

    <div class="quick-add">
        <div class="input-row">
            <input type="text" id="directNameInput" placeholder="è‡¨æ™‚ä»»å‹™åç¨±" style="flex:1">
            <input type="number" id="directPointInput" placeholder="åˆ†" style="width: 65px;">
            <button onclick="addHabitDirectly()" style="background:var(--success);color:white;border:none;border-radius:12px;padding:0 12px;">â•</button>
        </div>
        <div class="input-row">
            <select id="habitBankSelect" onchange="syncBankPoints()" style="flex:1"></select>
            <input type="number" id="bankPointInput" placeholder="åˆ†" style="width: 65px;">
            <button onclick="addHabitFromBankSelect()" style="background:var(--accent);color:white;border:none;border-radius:12px;padding:0 12px;">âˆš</button>
        </div>
    </div>

    <div style="display:flex; gap:12px;">
        <button onclick="undoLastAction()" class="btn-action btn-undo">â†© æ’¤éŠ·åŠ åˆ†</button>
        <button onclick="redeemPoints()" class="btn-action btn-redeem">ğŸ å…Œæ›çå‹µ</button>
    </div>

    <div class="report-section">
        <table class="report-table">
            <thead><tr><th>ä»»å‹™</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th><th>æ—¥</th></tr></thead>
            <tbody id="reportContent"></tbody>
        </table>
    </div>

    <div style="margin-top:30px; text-align:center;">
        <div onclick="toggleAdmin()" style="color:#b08968; font-size:0.85em; text-decoration:underline; cursor:pointer;">âš™ï¸ ç®¡ç†å“¡è¨­å®šèˆ‡éŠ€è¡Œ</div>
        <div id="adminPanel" class="admin-panel">
            <button style="background:var(--primary); color:white; width:100%; border:none; border-radius:12px; height:45px; font-weight:bold; margin-bottom:20px;" id="refreshBtn" onclick="syncDateWithBank()">ğŸ”„ åˆ·æ–°æ’ç¨‹æ¸…å–®</button>
            <h4 style="margin: 10px 0 10px; text-align:left; color:var(--accent);">ğŸ“œ éŠ€è¡Œæ¸…å–® (è§£é–å¾Œç·¨è¼¯)</h4>
            <div id="bankManagerList"></div>
            <div class="danger-zone">
                <button class="btn-secondary-outline" onclick="changeAppPassword()">ğŸ”‘ ä¿®æ”¹ç®¡ç†å¯†ç¢¼</button>
                <button onclick="fullReset()" style="color:#ccc; border:none; background:none; font-size:0.75em; cursor:pointer;">ğŸ”¥ å¾¹åº•æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡ç½®</button>
            </div>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'heroApp_Global_Storage';
    const dayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    let viewDate = new Date();
    const getTodayStr = (d) => d.toISOString().split('T')[0];
    const getDayIdx = (d) => (d.getDay() + 6) % 7;
    const getWeekNumber = (d) => {
        const date = new Date(d.getTime()); date.setHours(0, 0, 0, 0);
        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
        const week1 = new Date(date.getFullYear(), 0, 4);
        return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    };

    let isEditMode = false;
    let appData = JSON.parse(localStorage.getItem(DB_KEY)) || { b: [], h: {}, s: { w: 0, lp: 0, ln: "", ld: "" }, l: {}, pw: "2165", cw: getWeekNumber(new Date()) };
    function save() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); }

    // --- å·¥å…·æ¬„åŠŸèƒ½ ---
    function exportData() {
        const defaultName = `å°è¶…äººå‚™ä»½_${getTodayStr(new Date())}`;
        const backupName = prompt("è«‹ç‚ºå­˜æª”å‘½åï¼š", defaultName);
        if (backupName === null) return;
        const blob = new Blob([JSON.stringify(appData)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${backupName}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function importData() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (confirm(`è¼‰å…¥ã€Œ${file.name.replace('.json','')}ã€ï¼Ÿé€™æœƒè¦†è“‹ç›®å‰é€²åº¦ã€‚`)) {
                        appData = imported; save(); location.reload();
                    }
                } catch (err) { alert("æ ¼å¼éŒ¯èª¤ï¼"); }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function handleUnlockToggle() {
        if (!isEditMode) {
            const input = prompt("ç®¡ç†å¯†ç¢¼ï¼š");
            if (input === appData.pw) { 
                isEditMode = true; 
                document.getElementById('unlockBtn').innerText = "ğŸ”’ é€€å‡º"; 
                document.getElementById('unlockBtn').classList.add('active'); 
            }
        } else { 
            isEditMode = false; 
            document.getElementById('unlockBtn').innerText = "ğŸ”“ ç·¨è¼¯"; 
            document.getElementById('unlockBtn').classList.remove('active'); 
        }
        updateDisplay();
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function checkPermission() { if (!isEditMode) { alert("è«‹å…ˆé»æ“Šä¸Šæ–¹ã€ŒğŸ”“ ç·¨è¼¯ã€æŒ‰éˆ•"); return false; } return true; }
    function changeViewDate(offset) { viewDate.setDate(viewDate.getDate() + offset); updateDisplay(); }
    
    function updateDisplay() {
        const curStr = getTodayStr(viewDate);
        document.getElementById('dateDisplay').innerText = `${curStr} æ˜ŸæœŸ${dayNames[viewDate.getDay()]}`;
        document.getElementById('todayIndicator').style.display = (curStr !== getTodayStr(new Date())) ? 'block' : 'none';
        document.getElementById('totalWallet').innerText = appData.s.w;
        
        const tasks = appData.h[curStr] || [];
        document.getElementById('habitList').innerHTML = tasks.map((x, i) => `
            <div class="habit-item" data-id="${i}">
                <div class="drag-handle">â˜°</div>
                <div class="habit-info">
                    <input type="checkbox" style="width:22px;height:22px;" ${x.c ? 'checked' : ''} onchange="toggleCheck(${i})">
                    <span class="habit-name ${x.c ? 'checked' : ''}" onclick="editTask(${i})">${x.n}${x.p > 0 ? ` (+${x.p})` : ''}</span>
                </div>
                <button class="btn-done" style="display: ${x.c ? 'block' : 'none'}" onclick="completeHabit(${i})">é ˜æ˜Ÿ</button>
                ${isEditMode ? `<span onclick="removeHabit(${i})" style="color:#d5bdaf; font-size:1.5em; cursor:pointer; padding-left:10px;">Ã—</span>` : ''}
            </div>`).join('');

        const weekDays = getCurrWeekDays();
        const allTaskNames = [...new Set(Object.values(appData.h).flat().map(t => t.n))];
        document.getElementById('reportContent').innerHTML = allTaskNames.map(name => `
            <tr><td style="font-weight:600; text-align:left; padding-left:10px; color:#7f5539">${name}</td>
            ${weekDays.map(d => {
                const count = (appData.l[d] && appData.l[d][name]) ? appData.l[d][name] : 0;
                return `<td onclick="fixStar('${d}', '${name}')">${count > 0 ? `<span class="count-badge">${count}</span>` : '-'}</td>`;
            }).join('')}
            </tr>`).join('');

        document.getElementById('bankManagerList').innerHTML = appData.b.map((x, i) => `
            <div class="bank-item">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <b onclick="editBankTask(${i})" style="${isEditMode?'cursor:pointer;text-decoration:underline':''}">${x.n} (${x.p}åˆ†)</b>
                    ${isEditMode ? `<button onclick="removeFromBank(${i})" style="color:red; background:none; border:none;">åˆªé™¤</button>` : ''}
                </div>
                <div>
                    ${[0,1,2,3,4,5,6].map(d => `<span class="day-chip ${x.days && x.days.includes(d) ? 'active' : ''}" onclick="${isEditMode ? `toggleBankDay(${i}, ${d})` : ''}">${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][d]}</span>`).join('')}
                </div>
            </div>`).join('');

        document.getElementById('habitBankSelect').innerHTML = '<option value="">-- å¾éŠ€è¡Œé¸å– --</option>' + appData.b.map(x => `<option value="${x.n}">${x.n}</option>`).join('');
        initSortable();
    }

    function editTask(i) { if (!checkPermission()) return; const dStr = getTodayStr(viewDate); const cur = appData.h[dStr][i]; const n = prompt("åç¨±ï¼š", cur.n); if (n === null) return; const p = prompt("é»æ•¸ï¼š", cur.p); if (p !== null) { appData.h[dStr][i].n = n; appData.h[dStr][i].p = parseInt(p) || 0; save(); updateDisplay(); } }
    function editBankTask(i) { if (!checkPermission()) return; const cur = appData.b[i]; const n = prompt("é è¨­åç¨±ï¼š", cur.n); if (n === null) return; const p = prompt("é è¨­é»æ•¸ï¼š", cur.p); if (p !== null) { appData.b[i].n = n; appData.b[i].p = parseInt(p) || 0; save(); updateDisplay(); } }
    function completeHabit(i) {
        const dStr = getTodayStr(viewDate); const x = appData.h[dStr][i]; appData.s.w += x.p; appData.s.lp = x.p; appData.s.ln = x.n; appData.s.ld = dStr;
        if (!appData.l[dStr]) appData.l[dStr] = {}; appData.l[dStr][x.n] = (appData.l[dStr][x.n] || 0) + 1;
        appData.h[dStr][i].c = false; confetti({ particleCount: 150, spread: 70 }); save(); updateDisplay();
    }
    function undoLastAction() { if(appData.s.ln && confirm(`æ’¤éŠ·ã€Œ${appData.s.ln}ã€åŠ åˆ†ï¼Ÿ`)){ appData.s.w = Math.max(0, appData.s.w - appData.s.lp); if(appData.l[appData.s.ld] && appData.l[appData.s.ld][appData.s.ln] > 0) appData.l[appData.s.ld][appData.s.ln]--; appData.s.ln = ""; save(); updateDisplay(); } }
    function fixStar(d, n) { const cur = (appData.l[d] && appData.l[d][n]) ? appData.l[d][n] : 0; const act = prompt(`${n} æ¬¡æ•¸ï¼š`, cur); if (act !== null) { const v = parseInt(act); if (!isNaN(v) && v >= 0) { if (!appData.l[d]) appData.l[d] = {}; appData.l[d][n] = v; save(); updateDisplay(); } } }
    function addHabitDirectly() { const n = document.getElementById('directNameInput').value, p = parseInt(document.getElementById('directPointInput').value) || 0; if (n) { if(!appData.h[getTodayStr(viewDate)]) appData.h[getTodayStr(viewDate)] = []; appData.h[getTodayStr(viewDate)].push({ n, p, c: false }); save(); updateDisplay(); document.getElementById('directNameInput').value=''; } }
    function addHabitFromBankSelect() { const n = document.getElementById('habitBankSelect').value, p = parseInt(document.getElementById('bankPointInput').value) || 0; if (n) { if(!appData.h[getTodayStr(viewDate)]) appData.h[getTodayStr(viewDate)] = []; appData.h[getTodayStr(viewDate)].push({ n, p, c: false }); save(); updateDisplay(); } }
    function syncDateWithBank() { const curStr = getTodayStr(viewDate), curDayIdx = getDayIdx(viewDate); if (!appData.h[curStr]) appData.h[curStr] = []; appData.b.forEach(b => { if (b.days && b.days.includes(curDayIdx) && !appData.h[curStr].some(t => t.n === b.n)) appData.h[curStr].push({ n: b.n, p: b.p, c: false }); }); save(); updateDisplay(); }
    function toggleCheck(i) { appData.h[getTodayStr(viewDate)][i].c = !appData.h[getTodayStr(viewDate)][i].c; save(); updateDisplay(); }
    function getCurrWeekDays() { const curr = new Date(); const first = curr.getDate() - (curr.getDay() === 0 ? 6 : curr.getDay() - 1); return [...Array(7).keys()].map(i => new Date(new Date().setDate(first + i)).toISOString().split('T')[0]); }
    function initSortable() { const el = document.getElementById('habitList'); if(!el || !el.children.length) return; Sortable.create(el, { handle: '.drag-handle', animation: 150, onEnd: function() { const dStr = getTodayStr(viewDate); const newOrder = []; el.querySelectorAll('.habit-item').forEach(item => { newOrder.push(appData.h[dStr][item.getAttribute('data-id')]); }); appData.h[dStr] = newOrder; save(); }}); }
    function removeHabit(i) { appData.h[getTodayStr(viewDate)].splice(i, 1); save(); updateDisplay(); }
    function removeFromBank(i) { appData.b.splice(i, 1); save(); updateDisplay(); }
    function syncBankPoints() { const t = appData.b.find(x => x.n === document.getElementById('habitBankSelect').value); if(t) document.getElementById('bankPointInput').value = t.p; }
    function changeAppPassword() { if (!checkPermission()) return; const n = prompt("æ–°å¯†ç¢¼ï¼š"); if(n) { appData.pw = n; save(); } }
    function fullReset() { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿè³‡æ–™å°‡æ¶ˆå¤±ï¼")) { localStorage.clear(); location.reload(); } }
    function toggleAdmin() { const p = document.getElementById('adminPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function toggleBankDay(idx, d) { if (!appData.b[idx].days) appData.b[idx].days = []; const f = appData.b[idx].days.indexOf(d); if (f > -1) appData.b[idx].days.splice(f, 1); else appData.b[idx].days.push(d); save(); updateDisplay(); }
    function redeemPoints() { const c = prompt("æ‰£é™¤é»æ•¸ï¼š"); if(c && appData.s.w >= parseInt(c)) { appData.s.w -= parseInt(c); save(); updateDisplay(); } }

    updateDisplay();
</script>
</body>
</html>
