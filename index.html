<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è¶…äººæˆé•·å¤§å†’éšª v65</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #b08968; --secondary: #e6ccb2; --accent: #7f5539; --bg: #f5ebe0; --card: #ffffff; --success: #9c6644; --gold: #ddb892; --text: #432818; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; -webkit-touch-callout: none; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; justify-content: center; touch-action: pan-y; }
        .app-card { width: 100%; max-width: 600px; background: var(--card); border-radius: 35px; box-shadow: 0 10px 30px rgba(67,40,24,0.08); padding: 20px; min-height: 92vh; }
        .main-score { background: linear-gradient(135deg, var(--accent), var(--primary)); color: #fff; padding: 25px; border-radius: 28px; text-align: center; margin-bottom: 20px; }
        .main-score span { font-size: 3.5em; font-weight: 800; display: block; margin-top: 5px; }
        .system-toolbar { display: flex; gap: 8px; margin-bottom: 20px; }
        .btn-tool { flex: 1; padding: 10px 5px; border-radius: 15px; border: 1.5px solid var(--accent); background: white; color: var(--accent); font-weight: bold; cursor: pointer; font-size: 0.8em; }
        .btn-tool.active { background: #fde2e4; border-color: #f08080; color: #d00000; }
        .date-navigator { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: #ede0d4; border-radius: 12px; padding: 5px 15px; }
        .nav-arrow { font-size: 1.5em; color: var(--accent); cursor: pointer; padding: 5px 10px; }
        .habit-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 10px; border-bottom: 1px solid #fcf2e8; background: white; }
        .drag-handle { cursor: grab; color: #b08968; padding: 10px 20px 10px 5px; font-size: 1.4em; touch-action: none; user-select: none; }
        .habit-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .habit-name { font-size: 1.1em; font-weight: 600; color: var(--accent); cursor: pointer; }
        .habit-name.checked { color: #bb9457; text-decoration: line-through; opacity: 0.6; }
        .quick-add { background: #faf3e0; padding: 18px; border-radius: 22px; margin: 20px 0 12px 0; border: 1px solid #ede0d4; }
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        select, input { padding: 12px; border: 1.5px solid #ede0d4; border-radius: 14px; font-size: 15px; outline: none; }
        .btn-done { background: var(--success); color: white; border: none; padding: 10px 18px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 16px; font-weight: bold; cursor: pointer; }
        .admin-panel { display: none; background: #fdfaf7; padding: 20px; border-radius: 20px; margin-top: 15px; border: 1px solid #ede0d4; }
        .bank-item { background: white; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 12px; text-align: left; }
        .day-chip { display: inline-block; padding: 4px 8px; font-size: 0.8em; background: #eee; border-radius: 8px; margin-right: 4px; color: #999; cursor: pointer; }
        .day-chip.active { background: var(--accent); color: white; }
        .report-section { margin-top: 25px; background: #fff; padding: 10px; border-radius: 22px; border: 1.5px solid #ede0d4; overflow-x: auto; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.85em; text-align: center; min-width: 450px; }
        .report-table td { padding: 10px 0; border-bottom: 1px solid #fcf2e8; }
        .count-badge { background: var(--gold); color: var(--text); padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .btn-secondary-outline { width: 100%; padding: 8px; background: none; border: 1px solid #ccc; color: #999; border-radius: 10px; font-size: 0.85em; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="main-score"><div>COIN WALLET</div><span id="totalWallet">0</span></div>
    
    <div class="system-toolbar">
        <button class="btn-tool" onclick="exportData()">ğŸ“¤ åŒ¯å‡º</button>
        <button class="btn-tool" onclick="importData()">ğŸ“¥ åŒ¯å…¥</button>
        <button id="unlockBtn" class="btn-tool" onclick="toggleEditMode()">ğŸ”“ ç·¨è¼¯</button>
    </div>

    <div class="date-navigator">
        <div class="nav-arrow" onclick="changeDate(-1)">â—€</div>
        <div style="text-align:center"><div class="day-label" id="dateDisplay">è¼‰å…¥ä¸­...</div></div>
        <div class="nav-arrow" onclick="changeDate(1)">â–¶</div>
    </div>

    <div id="habitList"></div>

    <div class="quick-add">
        <div class="input-row">
            <input type="text" id="directName" placeholder="è‡¨æ™‚ä»»å‹™åç¨±" style="flex:1">
            <input type="number" id="directPoint" placeholder="åˆ†" style="width: 65px;">
            <button onclick="addFromInput('directName','directPoint')" style="background:var(--success);color:white;border:none;border-radius:12px;padding:0 12px;">â•</button>
        </div>
        <div class="input-row">
            <select id="bankSelect" onchange="syncBankPoints()" style="flex:1"></select>
            <input type="number" id="bankPoint" placeholder="åˆ†" style="width: 65px;">
            <button onclick="addFromInput('bankSelect','bankPoint')" style="background:var(--accent);color:white;border:none;border-radius:12px;padding:0 12px;">âˆš</button>
        </div>
    </div>

    <div style="display:flex; gap:12px;"><button onclick="undo()" class="btn-action" style="background:#ede0d4;color:var(--accent);">â†© æ’¤éŠ·</button><button onclick="redeem()" class="btn-action" style="background:var(--gold);color:#432818;">ğŸ å…Œæ›</button></div>

    <div class="report-section"><table class="report-table"><thead><tr><th>ä»»å‹™</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th><th>æ—¥</th></tr></thead><tbody id="reportContent"></tbody></table></div>

    <div style="margin-top:30px; text-align:center;">
        <div onclick="toggleAdmin()" style="color:#b08968; font-size:0.85em; text-decoration:underline; cursor:pointer;">âš™ï¸ ç®¡ç†å“¡èˆ‡éŠ€è¡Œç¯„æœ¬</div>
        <div id="adminPanel" class="admin-panel">
            <div id="bankAddSection" style="display:none; background:#fff; padding:15px; border-radius:18px; margin-bottom:20px; border:1px dashed var(--primary); text-align:left;">
                <h4 style="margin:0 0 10px 0; color:var(--accent);">âœ¨ æ–°å¢éŠ€è¡Œç¯„æœ¬</h4>
                <div class="input-row">
                    <input type="text" id="newBankName" placeholder="åç¨±" style="flex:1">
                    <input type="number" id="newBankPoint" placeholder="åˆ†" style="width:65px;">
                    <button onclick="addNewBankItem()" style="background:var(--primary); color:white; border:none; border-radius:12px; padding:0 15px;">å„²å­˜</button>
                </div>
            </div>

            <button style="background:var(--primary); color:white; width:100%; border:none; border-radius:12px; height:45px; font-weight:bold; margin-bottom:20px;" onclick="syncWithBank()">ğŸ”„ åˆ·æ–°ä»Šæ—¥æ’ç¨‹æ¸…å–®</button>
            <div id="bankManagerList"></div>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                <button class="btn-secondary-outline" onclick="changePw()">ğŸ”‘ ä¿®æ”¹ç®¡ç†å¯†ç¢¼</button>
                <button onclick="fullReset()" style="color:#ccc; border:none; background:none; font-size:0.75em; cursor:pointer; margin-top:10px;">ğŸ”¥ å¾¹åº•æ¸…é™¤é‡ç½®</button>
            </div>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'heroApp_Global_Storage';
    const dayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    let viewDate = new Date(), isEditMode = false;
    let appData = JSON.parse(localStorage.getItem(DB_KEY)) || { b: [], h: {}, s: { w: 0, lp: 0, ln: "", ld: "" }, l: {}, pw: "2165" };
    
    const save = () => localStorage.setItem(DB_KEY, JSON.stringify(appData));
    const curD = () => viewDate.toISOString().split('T')[0];
    const commit = () => { save(); updateDisplay(); };
    const checkPerm = () => isEditMode || (alert("è«‹å…ˆé»æ“Šä¸Šæ–¹ã€ŒğŸ”“ ç·¨è¼¯ã€") && false);

    function toggleEditMode() {
        if (!isEditMode) {
            if(prompt("ç®¡ç†å¯†ç¢¼ï¼š") === appData.pw) isEditMode = true;
        } else { isEditMode = false; }
        document.getElementById('unlockBtn').innerText = isEditMode ? "ğŸ”’ é€€å‡º" : "ğŸ”“ ç·¨è¼¯";
        document.getElementById('unlockBtn').classList.toggle('active', isEditMode);
        updateDisplay();
    }

    function updateDisplay() {
        const d = curD();
        document.getElementById('dateDisplay').innerText = `${d} (${dayNames[viewDate.getDay()]})`;
        document.getElementById('totalWallet').innerText = appData.s.w;
        document.getElementById('bankAddSection').style.display = isEditMode ? 'block' : 'none';
        
        const tasks = appData.h[d] || [];
        document.getElementById('habitList').innerHTML = tasks.map((x, i) => `
            <div class="habit-item" data-id="${i}"><div class="drag-handle">â˜°</div>
                <div class="habit-info">
                    <input type="checkbox" style="width:22px;height:22px;" ${x.c?'checked':''} onchange="toggleCheck(${i})">
                    <span class="habit-name ${x.c?'checked':''}" onclick="editTask(${i})">${x.n} (+${x.p})</span>
                </div>
                <button class="btn-done" style="display:${x.c?'block':'none'}" onclick="complete(${i})">é ˜æ˜Ÿ</button>
                ${isEditMode ? `<span onclick="removeH(${i})" style="color:#d5bdaf; font-size:1.5em; padding-left:10px; cursor:pointer;">Ã—</span>` : ''}
            </div>`).join('');

        document.getElementById('bankManagerList').innerHTML = appData.b.map((x, i) => `
            <div class="bank-item"><div style="display:flex; justify-content:space-between;"><b onclick="editBank(${i})">${x.n} (${x.p}åˆ†)</b>${isEditMode?`<button onclick="removeB(${i})" style="color:red;border:none;background:none;">åˆªé™¤</button>`:''}</div>
            <div style="margin-top:5px;">${[0,1,2,3,4,5,6].map(di => `<span class="day-chip ${x.days?.includes(di)?'active':''}" onclick="${isEditMode?`toggleBD(${i},${di})`:''}">${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][di]}</span>`).join('')}</div></div>`).join('');

        document.getElementById('bankSelect').innerHTML = '<option value="">-- å¾éŠ€è¡Œé¸å– --</option>' + appData.b.map(x => `<option value="${x.n}">${x.n}</option>`).join('');
        updateReport(); initSortable();
    }

    function updateReport() {
        const curr = new Date(); const first = curr.getDate() - (curr.getDay() === 0 ? 6 : curr.getDay() - 1);
        const days = [...Array(7).keys()].map(i => new Date(new Date().setDate(first + i)).toISOString().split('T')[0]);
        const names = [...new Set(Object.values(appData.h).flat().map(t => t.n))];
        document.getElementById('reportContent').innerHTML = names.map(n => `<tr><td style="text-align:left; padding-left:10px;">${n}</td>${days.map(d => `<td onclick="fixStar('${d}','${n}')">${appData.l[d]?.[n] ? `<span class="count-badge">${appData.l[d][n]}</span>` : '-'}</td>`).join('')}</tr>`).join('');
    }

    function changeDate(o) { viewDate.setDate(viewDate.getDate() + o); updateDisplay(); }
    function toggleCheck(i) { appData.h[curD()][i].c = !appData.h[curD()][i].c; commit(); }
    function removeH(i) { appData.h[curD()].splice(i, 1); commit(); }
    function removeB(i) { appData.b.splice(i, 1); commit(); }
    function complete(i) {
        const d = curD(), x = appData.h[d][i]; appData.s.w += x.p; appData.s.lp = x.p; appData.s.ln = x.n; appData.s.ld = d;
        if (!appData.l[d]) appData.l[d] = {}; appData.l[d][x.n] = (appData.l[d][x.n] || 0) + 1;
        appData.h[d][i].c = false; confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); commit();
    }
    function addFromInput(ni, pi) {
        const n = document.getElementById(ni).value, p = parseInt(document.getElementById(pi).value) || 0;
        if (n) { if(!appData.h[curD()]) appData.h[curD()] = []; appData.h[curD()].push({ n, p, c: false }); document.getElementById(ni).value=''; commit(); }
    }
    function addNewBankItem() {
        const n = document.getElementById('newBankName').value, p = parseInt(document.getElementById('newBankPoint').value) || 0;
        if (n) { appData.b.push({ n, p, days: [0,1,2,3,4,5,6] }); document.getElementById('newBankName').value=''; document.getElementById('newBankPoint').value=''; commit(); }
    }
    function editTask(i) { if(!checkPerm()) return; const x = appData.h[curD()][i]; const n = prompt("åç¨±", x.n); if(n) { appData.h[curD()][i].n = n; appData.h[curD()][i].p = parseInt(prompt("åˆ†æ•¸", x.p))||0; commit(); } }
    function editBank(i) { if(!checkPerm()) return; const x = appData.b[i]; const n = prompt("åç¨±", x.n); if(n) { appData.b[i].n = n; appData.b[i].p = parseInt(prompt("åˆ†æ•¸", x.p))||0; commit(); } }
    function toggleBD(i, d) { if(!appData.b[i].days) appData.b[i].days = []; const idx = appData.b[i].days.indexOf(d); if(idx>-1) appData.b[i].days.splice(idx,1); else appData.b[i].days.push(d); commit(); }
    function syncWithBank() { const d = curD(), di = (viewDate.getDay()+6)%7; if(!appData.h[d]) appData.h[d] = []; appData.b.forEach(b => { if(b.days?.includes(di) && !appData.h[d].some(t => t.n === b.n)) appData.h[d].push({n:b.n, p:b.p, c:false}); }); commit(); }
    function undo() { if(appData.s.ln && confirm(`æ’¤éŠ·ã€Œ${appData.s.ln}ã€åŠ åˆ†ï¼Ÿ`)){ appData.s.w = Math.max(0, appData.s.w - appData.s.lp); if(appData.l[appData.s.ld]?.[appData.s.ln]>0) appData.l[appData.s.ld][appData.s.ln]--; appData.s.ln=""; commit(); } }
    function fixStar(d, n) { const act = prompt(`${n} æ¬¡æ•¸`, appData.l[d]?.[n]||0); if(act!==null) { if(!appData.l[d]) appData.l[d]={}; appData.l[d][n]=parseInt(act)||0; commit(); } }
    function redeem() { const c = prompt("æ‰£é™¤é»æ•¸"); if(c && appData.s.w >= parseInt(c)) { appData.s.w -= parseInt(c); commit(); } }
    function exportData() { const n = prompt("å­˜æª”åç¨±", `å°è¶…äººå‚™ä»½_${curD()}`); if(n) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(appData)], {type:'application/json'})); a.download=`${n}.json`; a.click(); } }
    function importData() { const i = document.createElement('input'); i.type='file'; i.accept='.json'; i.onchange=e=>{ const r = new FileReader(); r.onload=ev=>{ try{ appData=JSON.parse(ev.target.result); commit(); location.reload(); }catch(e){alert("æ ¼å¼éŒ¯èª¤");} }; r.readAsText(e.target.files[0]); }; i.click(); }
    function initSortable() {
        const el = document.getElementById('habitList'); if(!el || !el.children.length) return;
        if(window.stb) window.stb.destroy();
        window.stb = Sortable.create(el, { handle:'.drag-handle', animation:200, delay:100, delayOnTouchOnly:true, touchStartThreshold:5, onEnd: () => {
            const d = curD(), nOrder = []; el.querySelectorAll('.habit-item').forEach(item => nOrder.push(appData.h[d][item.getAttribute('data-id')]));
            appData.h[d] = nOrder; save(); updateDisplay();
        }});
    }
    function syncBankPoints() { const t = appData.b.find(x => x.n === document.getElementById('bankSelect').value); if(t) document.getElementById('bankPoint').value = t.p; }
    function changePw() { if(!checkPerm()) return; const n = prompt("æ–°ç®¡ç†å¯†ç¢¼"); if(n) { appData.pw = n; commit(); } }
    function fullReset() { if(confirm("å°‡æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function toggleAdmin() { const p = document.getElementById('adminPanel'); p.style.display = p.style.display==='block'?'none':'block'; }

    updateDisplay();
</script>
</body>
</html>
