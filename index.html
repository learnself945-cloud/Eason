<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>å°è¶…äººæˆé•·å¤§å†’éšª v37-FlexPoint</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --primary: #b08968; --secondary: #e6ccb2; --accent: #7f5539; 
            --bg: #f5ebe0; --card: #ffffff; --success: #9c6644; 
            --gold: #ddb892; --text: #432818;
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .app-card { width: 100%; max-width: 600px; background: var(--card); border-radius: 35px; box-shadow: 0 10px 30px rgba(67,40,24,0.08); padding: 25px; min-height: 92vh; }
        
        .main-score { background: linear-gradient(135deg, var(--accent), var(--primary)); color: #fff; padding: 25px; border-radius: 28px; text-align: center; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(127,85,57,0.2); }
        .main-score span { font-size: 3.5em; font-weight: 800; display: block; margin-top: 5px; }
        
        .day-label { font-size: 1.1em; font-weight: bold; color: var(--accent); margin-bottom: 10px; display: block; text-align: center; background: #ede0d4; padding: 5px; border-radius: 10px; }

        .quick-add { background: #faf3e0; padding: 18px; border-radius: 22px; margin-bottom: 20px; border: 1px solid #ede0d4; }
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        select, input { padding: 12px; border: 1.5px solid #ede0d4; border-radius: 14px; font-size: 16px; outline: none; background: white; color: var(--text); }
        .add-btn { background: var(--accent); color: white; border: none; padding: 0 20px; border-radius: 14px; font-weight: bold; cursor: pointer; }

        .habit-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 10px; border-bottom: 1px solid #fcf2e8; }
        .habit-info { display: flex; align-items: center; gap: 12px; flex: 1; }
        .habit-checkbox { width: 24px; height: 24px; accent-color: var(--accent); cursor: pointer; }
        .habit-name { font-size: 1.1em; font-weight: 600; color: var(--accent); cursor: pointer; text-decoration: underline dotted #d5bdaf; }
        .habit-name.checked { color: #bb9457; text-decoration: line-through; opacity: 0.6; }

        .btn-done { background: var(--success); color: white; border: none; padding: 10px 18px; border-radius: 25px; font-weight: bold; box-shadow: 0 4px 0 #7f5539; cursor: pointer; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 16px; font-weight: bold; cursor: pointer; font-size: 1em; }
        .btn-undo { background: #ede0d4; color: var(--accent); }
        .btn-redeem { background: var(--gold); color: #432818; }
        .btn-sync { background: var(--primary); color: white; width: 100%; margin-bottom: 15px; height: 50px; border: none; border-radius: 16px; font-weight: bold; cursor: pointer; }

        .report-section { margin-top: 25px; background: #fff; padding: 10px; border-radius: 22px; border: 1.5px solid #ede0d4; overflow-x: auto; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.85em; text-align: center; min-width: 450px; }
        .report-table th { padding: 10px; color: var(--primary); border-bottom: 2px solid #f0ead2; }
        .star-cell { cursor: pointer; color: var(--accent); font-weight: bold; }

        .admin-panel { display: none; background: #fdfaf7; padding: 20px; border-radius: 20px; margin-top: 15px; border: 1px solid #ede0d4; }
        .bank-item { padding: 12px 0; border-bottom: 1.5px solid #ede0d4; }
        .bank-header { display: flex; justify-content: space-between; align-items: center; }
        .emoji-box { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; justify-content: center; background: white; padding: 10px; border-radius: 15px; border: 1px solid #ede0d4; }
        .emoji-item { font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .day-check-group { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 5px; }
        .day-check-group label { font-size: 0.7em; background: #fff; padding: 3px 6px; border-radius: 6px; border: 1px solid #ede0d4; cursor: pointer; }
        .btn-sm { font-size: 0.75em; padding: 5px 8px; border-radius: 8px; border: 1px solid #ede0d4; background: white; cursor: pointer; color: var(--accent); margin-left: 4px; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="main-score">
        <div>COIN WALLET</div>
        <span id="totalWallet">0</span>
    </div>

    <div class="day-label" id="todayLabel"></div>

    <div class="quick-add">
        <div class="input-row">
            <select id="habitBankSelect" onchange="syncPoints()"></select>
            <input type="number" id="pointInput" placeholder="åˆ†" style="width: 65px;">
            <button class="add-btn" onclick="addHabitFromSelect()">ï¼‹</button>
        </div>
    </div>

    <div id="habitList"></div>

    <div style="display:flex; gap:12px; margin-top:20px;">
        <button onclick="undoLastAction()" class="btn-action btn-undo">â†© æ’¤éŠ·åŠ åˆ†</button>
        <button onclick="redeemPoints()" class="btn-action btn-redeem">ğŸ å…Œæ›çå‹µ</button>
    </div>

    <div class="report-section">
        <table class="report-table">
            <thead><tr><th>TASK</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th><th>æ—¥</th></tr></thead>
            <tbody id="reportContent"></tbody>
        </table>
    </div>

    <div style="margin-top:30px; text-align:center; padding-bottom: 20px;">
        <div onclick="toggleAdmin()" style="color:#b08968; font-size:0.85em; text-decoration:underline; cursor:pointer;">âš™ï¸ SETTINGS (è¨­å®šèˆ‡åœ–åº«)</div>
        <div id="adminPanel" class="admin-panel">
            <button class="btn-sync" onclick="syncTodayWithBank()">ğŸ”„ ä¾ç…§æ’ç¨‹æ›´æ–°ä»Šæ—¥æ¸…å–®</button>
            <h4 style="margin: 10px 0; color:var(--accent);">åœ–åº«é¸æ“‡</h4>
            <div class="emoji-box" id="emojiPicker"></div>
            <div class="input-row">
                <input type="text" id="newBankName" placeholder="é¸åœ–æ¨™æˆ–è¼¸åç¨±" style="flex:2">
                <input type="number" id="newBankPoints" placeholder="åˆ†" style="width:55px">
                <button onclick="addToBank()" style="background:var(--success); color:white; border:none; border-radius:12px; padding:0 15px;">å„²å­˜</button>
            </div>
            <h4 style="margin: 20px 0 10px; color:var(--accent);">ä»»å‹™éŠ€è¡Œ (æ’ç¨‹è¨­å®š)</h4>
            <div id="bankList" style="text-align:left; max-height:300px; overflow-y:auto; margin-bottom:15px; padding-right:5px;"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-sm" style="flex:1" onclick="exportData()">ğŸ“¤ å‚™ä»½</button>
                <button class="btn-sm" style="flex:1" onclick="importData()">ğŸ“¥ é‚„åŸ</button>
            </div>
            <button onclick="fullReset()" style="width:100%; margin-top:20px; color:#ccc; border:none; background:none; font-size:0.7em;">ğŸ”¥ å¾¹åº•é‡è¨­ç³»çµ±</button>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'heroApp_Global_Storage';
    const dayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    const emojis = ["ğŸ§ ", "ğŸ“–", "ğŸ§¹", "ğŸ“", "ğŸ’»", "ğŸ¹", "ğŸ€", "ğŸ¨", "ğŸ§ª", "ğŸš¿", "ğŸƒ", "ğŸ›Œ", "ğŸ", "ğŸ§¸", "ğŸŒŸ", "âœ¨"];
    const todayStr = new Date().toISOString().split('T')[0];
    const todayDayIdx = (new Date().getDay() + 6) % 7; 

    const defaultBank = [
        {n: "ğŸ§  å¥§æ•¸", p: 20, days:[0,1,2,3,4,5,6]},
        {n: "ğŸ“– è‹±æ–‡é›œèªŒ", p: 15, days:[0,1,2,3,4,5,6]},
        {n: "ğŸ§¹ å®¶äº‹", p: 10, days:[0,1,2,3,4,5,6]}
    ];

    let appData = JSON.parse(localStorage.getItem(DB_KEY)) || { 
        b: defaultBank, h: {}, s: { w: 0, lp: 0, ln: "", ld: "" }, l: {} 
    };

    function save() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); }

    function initDayTasks() {
        if (!appData.h[todayStr]) {
            appData.h[todayStr] = appData.b
                .filter(item => item.days && item.days.includes(todayDayIdx))
                .map(item => ({ n: item.n, p: item.p, c: false }));
            save();
        }
    }

    function updateDisplay() {
        document.getElementById('totalWallet').innerText = appData.s.w;
        document.getElementById('todayLabel').innerText = `ä»Šå¤©æ˜¯æ˜ŸæœŸ${dayNames[new Date().getDay()]}`;
        document.getElementById('habitBankSelect').innerHTML = '<option value="">-- å¿«é€ŸåŠ å…¥ --</option>' + 
            appData.b.map(x => `<option value="${x.n}">${x.n}</option>`).join('');

        const tasks = appData.h[todayStr] || [];
        document.getElementById('habitList').innerHTML = tasks.map((x, i) => `
            <div class="habit-item">
                <div class="habit-info">
                    <input type="checkbox" class="habit-checkbox" ${x.c ? 'checked' : ''} onchange="toggleCheck(${i})">
                    <span class="habit-name ${x.c ? 'checked' : ''}" onclick="editHabitDetails(${i})">${x.n}${x.p > 0 ? ` (+${x.p})` : ''}</span>
                </div>
                <button class="btn-done" style="display: ${x.c ? 'block' : 'none'}" onclick="completeHabit(${i})">å®Œæˆé ˜æ˜Ÿ</button>
                <span onclick="removeHabit(${i})" style="color:#d5bdaf; padding-left:12px; cursor:pointer; font-size:1.5em; display:${x.c?'none':'block'}">Ã—</span>
            </div>`).join('');

        const weekDays = getCurrWeekDays();
        const allTaskNames = [...new Set(Object.values(appData.h).flat().map(t => t.n))];
        document.getElementById('reportContent').innerHTML = allTaskNames.map(name => `
            <tr><td style="font-weight:600; color:#7f5539">${name}</td>
            ${weekDays.map(d => `<td class="star-cell" onclick="fixStar('${d}', '${name}')">${(appData.l[d] && appData.l[d][name]) ? 'â­<br>('+appData.l[d][name]+')' : '-'}</td>`).join('')}
            </tr>`).join('');

        document.getElementById('bankList').innerHTML = appData.b.map((x, i) => `
            <div class="bank-item">
                <div class="bank-header">
                    <span style="font-weight:600">${x.n} (${x.p}åˆ†)</span>
                    <div>
                        <button class="btn-sm" onclick="editBank(${i})">ç·¨</button>
                        <button class="btn-sm" style="color:#9c6644" onclick="removeFromBank(${i})">x</button>
                    </div>
                </div>
                <div class="day-check-group">
                    ${[1,2,3,4,5,6,0].map((d, di) => {
                        const actualIdx = (d + 6) % 7;
                        return `<label><input type="checkbox" ${x.days.includes(actualIdx)?'checked':''} onchange="toggleBankDay(${i}, ${actualIdx})">${dayNames[d]}</label>`;
                    }).join('')}
                </div>
            </div>`).join('');

        document.getElementById('emojiPicker').innerHTML = emojis.map(e => `
            <span class="emoji-item" onclick="document.getElementById('newBankName').value='${e} '+document.getElementById('newBankName').value">${e}</span>
        `).join('');
    }

    // æ›´æ–°ï¼šåŒæ™‚ä¿®æ”¹åç¨±èˆ‡é»æ•¸
    function editHabitDetails(i) {
        const currentTask = appData.h[todayStr][i];
        const newName = prompt("ç·¨è¼¯ä»Šæ—¥ä»»å‹™åç¨±ï¼š", currentTask.n);
        if (newName !== null) {
            const newPoints = prompt("ç·¨è¼¯æ­¤ä»»å‹™ä»Šæ—¥åŠ åˆ†é»æ•¸ï¼š", currentTask.p);
            if (newPoints !== null) {
                appData.h[todayStr][i].n = newName || currentTask.n;
                appData.h[todayStr][i].p = parseInt(newPoints) || 0;
                save();
                updateDisplay();
            }
        }
    }

    function toggleCheck(i) { appData.h[todayStr][i].c = !appData.h[todayStr][i].c; save(); updateDisplay(); }

    function completeHabit(i) {
        const x = appData.h[todayStr][i];
        appData.s.w += x.p; appData.s.lp = x.p; appData.s.ln = x.n; appData.s.ld = todayStr;
        if (!appData.l[todayStr]) appData.l[todayStr] = {};
        appData.l[todayStr][x.n] = (appData.l[todayStr][x.n] || 0) + 1;
        appData.h[todayStr][i].c = false;
        confetti({ particleCount: 150, spread: 70, colors: ['#ddb892', '#b08968', '#7f5539', '#ffffff'] });
        save(); updateDisplay();
    }

    function syncTodayWithBank() {
        if (!appData.h[todayStr]) appData.h[todayStr] = [];
        let addedCount = 0;
        appData.b.forEach(bankItem => {
            if (bankItem.days.includes(todayDayIdx)) {
                if (!appData.h[todayStr].some(t => t.n === bankItem.n)) {
                    appData.h[todayStr].push({ n: bankItem.n, p: bankItem.p, c: false });
                    addedCount++;
                }
            }
        });
        save(); updateDisplay();
        alert(addedCount > 0 ? `å·²åŒæ­¥ ${addedCount} é …ä»»å‹™ï¼` : "ä»Šæ—¥æ¸…å–®å·²å°é½Šã€‚");
    }

    function toggleBankDay(bankIdx, dayIdx) {
        const item = appData.b[bankIdx];
        item.days = item.days.includes(dayIdx) ? item.days.filter(d => d !== dayIdx) : [...item.days, dayIdx];
        save(); updateDisplay();
    }

    function editBank(i) {
        const newN = prompt("ä¿®æ”¹éŠ€è¡Œé …ç›®åç¨±ï¼š", appData.b[i].n);
        const newP = prompt("ä¿®æ”¹é è¨­åŠ åˆ†ï¼š", appData.b[i].p);
        if (newN !== null && newP !== null) { appData.b[i].n = newN; appData.b[i].p = parseInt(newP) || 0; save(); updateDisplay(); }
    }

    function syncPoints() { const t = appData.b.find(x => x.n === document.getElementById('habitBankSelect').value); if(t) document.getElementById('pointInput').value = t.p; }
    function addHabitFromSelect() {
        const n = document.getElementById('habitBankSelect').value, p = parseInt(document.getElementById('pointInput').value) || 0;
        if (n) { if(!appData.h[todayStr]) appData.h[todayStr] = []; appData.h[todayStr].push({ n, p, c: false }); save(); updateDisplay(); }
    }
    function addToBank() {
        const n = document.getElementById('newBankName').value, p = parseInt(document.getElementById('newBankPoints').value) || 0;
        if (n) { appData.b.push({ n, p, days: [0,1,2,3,4,5,6] }); save(); updateDisplay(); document.getElementById('newBankName').value = ''; }
    }
    function removeFromBank(i) { if(confirm("å¾éŠ€è¡Œæ°¸ä¹…åˆªé™¤ï¼Ÿ")) { appData.b.splice(i, 1); save(); updateDisplay(); } }
    function removeHabit(i) { appData.h[todayStr].splice(i, 1); save(); updateDisplay(); }

    function fixStar(date, name) {
        if (appData.l[date] && appData.l[date][name] > 0 && confirm(`åˆªé™¤æ˜Ÿæ˜Ÿä¸¦æ‰£åˆ†ï¼Ÿ`)) {
            const t = appData.b.find(x => x.n === name) || {p:0};
            appData.l[date][name]--; appData.s.w = Math.max(0, appData.s.w - t.p);
            save(); updateDisplay();
        }
    }
    function undoLastAction() {
        if(appData.s.ln && confirm(`æ’¤éŠ·æœ€å¾Œä¸€æ¬¡åŠ åˆ†ï¼Ÿ`)){
            const d = appData.s.ld, n = appData.s.ln;
            if(appData.l[d] && appData.l[d][n] > 0) appData.l[d][n]--;
            appData.s.w = Math.max(0, appData.s.w - appData.s.lp);
            appData.s.ln = ""; save(); updateDisplay();
        }
    }
    function exportData() {
        const code = btoa(encodeURIComponent(JSON.stringify(appData))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        navigator.clipboard.writeText(code).then(() => alert(`å‚™ä»½ç¢¼å·²è¤‡è£½`));
    }
    function importData() {
        let code = prompt("è¼¸å…¥é‚„åŸç¢¼ï¼š");
        if(code){
            try {
                code = code.replace(/-/g, '+').replace(/_/g, '/');
                while (code.length % 4) code += '=';
                appData = JSON.parse(decodeURIComponent(atob(code)));
                save(); location.reload();
            } catch (e) { alert("ä»£ç¢¼éŒ¯èª¤"); }
        }
    }
    function getCurrWeekDays() {
        const curr = new Date();
        const first = curr.getDate() - (curr.getDay() === 0 ? 6 : curr.getDay() - 1);
        return [...Array(7).keys()].map(i => new Date(new Date().setDate(first + i)).toISOString().split('T')[0]);
    }
    function toggleAdmin() { const p = document.getElementById('adminPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function redeemPoints() { 
        const c = prompt("æ‰£å¹¾åˆ†å…Œæ›ï¼Ÿ"); 
        if(c && appData.s.w >= parseInt(c)){ appData.s.w -= parseInt(c); save(); updateDisplay(); } 
    }
    function fullReset() { if(confirm("ç¢ºå®šå¾¹åº•æ¸…ç©ºï¼Ÿ")){ localStorage.clear(); location.reload(); } }

    initDayTasks();
    updateDisplay();
</script>
</body>
</html>
