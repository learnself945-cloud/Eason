<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¶…äººæˆé•·å¤§å†’éšª - ç©©å®šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --secondary: #ff7675; --success: #00b894; --gold: #feca57; --bg: #fdfcf0; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .app-card { width: 100%; max-width: 600px; background: white; border-radius: 30px; box-shadow: 0 15px 35px rgba(108,92,231,0.15); padding: 25px; }
        
        .main-score { background: linear-gradient(135deg, var(--primary), #a29bfe); color: white; padding: 20px; border-radius: 25px; text-align: center; margin-bottom: 20px; border: 4px solid #eee; }
        .main-score span { font-size: 3.2em; font-weight: bold; display: block; }

        .quick-add { background: #f8f9fa; padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 2px solid #eee; }
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        select, input { padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; outline: none; }
        select { flex: 2; background: white; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }

        .habit-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px dashed #eee; }
        .btn-done { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #008a6f; }
        .btn-done:active { transform: translateY(2px); box-shadow: none; }

        .report-section { margin-top: 30px; background: #fff; padding: 15px; border-radius: 20px; border: 2px solid #f0f0ff; overflow-x: auto; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.8em; text-align: center; min-width: 450px; }
        .report-table th, .report-table td { padding: 10px 5px; border: 1px solid #f0f0ff; }
        .today-col { background-color: #fffde7; }

        .admin-panel { display: none; background: #fafafa; padding: 15px; border-radius: 15px; margin-top: 10px; border: 1px solid #eee; }
        .bank-item { display: flex; justify-content: space-between; font-size: 0.85em; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="main-score">
        <div>âœ¨ ç›®å‰æ˜Ÿæ˜Ÿè²¡å¯Œ âœ¨</div>
        <span id="totalWallet">0</span>
    </div>

    <div class="quick-add">
        <h4 style="margin:0 0 10px 0; color:#666;">ğŸ“ æ–°å¢ä»Šæ—¥ä»»å‹™</h4>
        <div class="input-row">
            <select id="habitBankSelect" onchange="syncPoints()">
                <option value="">-- é¸æ“‡å¸¸ç”¨ä»»å‹™ --</option>
            </select>
            <input type="number" id="pointInput" placeholder="åˆ†" style="width: 60px;">
            <button class="add-btn" onclick="addHabitFromSelect()">æ–°å¢</button>
        </div>
        <div style="font-size: 0.75em; color: #888;">é¸å–ä¸Šæ–¹æ¸…å–®ï¼Œæˆ–åœ¨ä¸‹æ–¹ã€Œç®¡ç†ã€ä¸­æ–°å¢å¸¸é§é¸é …ã€‚</div>
    </div>

    <div id="habitList"></div>

    <div style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="undoLastAction()" style="flex:1; padding:12px; border:none; background:#eee; border-radius:12px; cursor:pointer;">â†©ï¸ æ’¤éŠ·</button>
        <button onclick="redeemPoints()" style="flex:1; padding:12px; border:none; background:var(--gold); border-radius:12px; cursor:pointer; font-weight:bold;">ğŸ å…Œæ›</button>
    </div>

    <div class="report-section">
        <h3 style="margin:0 0 10px 0; font-size:1em; text-align:center;">ğŸ† æœ¬é€±æˆå°±åœ°åœ–</h3>
        <table class="report-table">
            <thead>
                <tr><th>ä»»å‹™</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th><th>æ—¥</th></tr>
            </thead>
            <tbody id="reportContent"></tbody>
        </table>
    </div>

    <div style="margin-top:40px; text-align:center;">
        <div onclick="toggleAdmin()" style="color:#ccc; font-size:0.8em; text-decoration:underline; cursor:pointer;">âš™ï¸ å®¶é•·ç®¡ç†è¨­å®šç®±</div>
        <div id="adminPanel" class="admin-panel">
            <h4 style="margin:0 0 10px 0;">ğŸ¦ å¸¸ç”¨ä»»å‹™éŠ€è¡Œ (è¨˜æ†¶æ¸…å–®)</h4>
            <div class="input-row">
                <input type="text" id="newBankName" placeholder="ä»»å‹™å" style="flex:2">
                <input type="number" id="newBankPoints" placeholder="åˆ†" style="width:50px">
                <button onclick="addToBank()" style="background:var(--success); color:white; border:none; padding:10px; border-radius:10px;">å­˜å…¥</button>
            </div>
            <div id="bankList" style="text-align:left; max-height:150px; overflow-y:auto;"></div>
            <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
            <button onclick="resetWeeklyOnly()" style="width:100%; padding:10px; color:#ff7675; border:1px solid #ff7675; background:none; border-radius:10px; margin-bottom:5px;">âš ï¸ åƒ…é‡è¨­æœ¬é€±æ•¸æ“š</button>
            <button onclick="fullReset()" style="width:100%; padding:10px; color:#999; border:1px solid #ddd; background:none; border-radius:10px;">ğŸ”¥ å¾¹åº•æ¸…ç©ºç³»çµ±</button>
        </div>
    </div>
</div>

<script>
    // éŸ³æ•ˆ
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(f1, f2) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(f1, now);
        osc.frequency.exponentialRampToValueAtTime(f2, now + 0.1);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
        osc.start(); osc.stop(now + 0.2);
    }

    // åˆå§‹åŒ–è³‡æ–™ (ä½¿ç”¨æ–°ç‰ˆæœ¬ key é¿å…èˆŠè³‡æ–™å¹²æ“¾)
    let habitBank = JSON.parse(localStorage.getItem('heroBank_v9')) || [
        {name: "ğŸ“š é–±è®€20åˆ†é˜", points: 10},
        {name: "ğŸ¦· ä¹–ä¹–åˆ·ç‰™", points: 5}
    ];
    let habits = JSON.parse(localStorage.getItem('heroHabits_v9')) || [];
    let stats = JSON.parse(localStorage.getItem('heroStats_v9')) || { totalWallet: 0, weekStars: 0, weekCount: 0, lastPoints: 0, lastHabitName: "" };
    let logs = JSON.parse(localStorage.getItem('heroLogs_v9')) || {};

    function save() {
        localStorage.setItem('heroBank_v9', JSON.stringify(habitBank));
        localStorage.setItem('heroHabits_v9', JSON.stringify(habits));
        localStorage.setItem('heroStats_v9', JSON.stringify(stats));
        localStorage.setItem('heroLogs_v9', JSON.stringify(logs));
    }

    // ä¸‹æ‹‰é¸å–®é€£å‹•åˆ†æ•¸
    function syncPoints() {
        const val = document.getElementById('habitBankSelect').value;
        const task = habitBank.find(h => h.name === val);
        if (task) document.getElementById('pointInput').value = task.points;
    }

    // å°‡å¸¸ç”¨ä»»å‹™æ–°å¢åˆ°ã€Œä»Šæ—¥æ¸…å–®ã€
    function addHabitFromSelect() {
        const name = document.getElementById('habitBankSelect').value;
        const points = parseInt(document.getElementById('pointInput').value);
        if (!name) { alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ä»»å‹™ï¼"); return; }
        
        // å…è¨±é‡è¤‡æ–°å¢ï¼Œæˆ–è€…æª¢æŸ¥æ˜¯å¦å·²åœ¨æ¸…å–®
        if (habits.some(h => h.name === name)) {
            alert("é€™å€‹ä»»å‹™å·²ç¶“åœ¨ä»Šæ—¥æ¸…å–®ä¸­äº†ï¼");
        } else {
            habits.push({ name, points });
            save();
            updateDisplay();
        }
    }

    // æ–°å¢åˆ°å¸¸ç”¨éŠ€è¡Œ
    function addToBank() {
        const name = document.getElementById('newBankName').value;
        const points = parseInt(document.getElementById('newBankPoints').value) || 5;
        if (name) {
            habitBank.push({ name, points });
            document.getElementById('newBankName').value = '';
            document.getElementById('newBankPoints').value = '';
            save();
            updateDisplay();
        }
    }

    // æ‰“å¡å®Œæˆ
    function completeHabit(i) {
        const h = habits[i];
        const today = new Date().toISOString().split('T')[0];
        stats.totalWallet += h.points;
        stats.weekStars += h.points;
        stats.weekCount += 1;
        stats.lastPoints = h.points;
        stats.lastHabitName = h.name;

        if (!logs[today]) logs[today] = {};
        logs[today][h.name] = (logs[today][h.name] || 0) + 1;

        playSound(523, 1046);
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        save();
        updateDisplay();
    }

    function updateDisplay() {
        document.getElementById('totalWallet').innerText = stats.totalWallet;

        // åˆ·æ–°é¸å–®
        const select = document.getElementById('habitBankSelect');
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- é¸æ“‡å¸¸ç”¨ä»»å‹™ --</option>' + 
            habitBank.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
        select.value = currentVal;

        // åˆ·æ–°ä»Šæ—¥æ¸…å–®
        const list = document.getElementById('habitList');
        list.innerHTML = habits.map((h, i) => `
            <div class="habit-item">
                <span><b>${h.name}</b> <small>(+${h.points})</small></span>
                <div>
                    <button class="btn-done" onclick="completeHabit(${i})">å®Œæˆ</button>
                    <button onclick="removeHabit(${i})" style="border:none;background:none;color:#ccc;margin-left:8px;cursor:pointer;">Ã—</button>
                </div>
            </div>
        `).join('');

        // åˆ·æ–°å ±è¡¨
        const tbody = document.getElementById('reportContent');
        const weekDays = getCurrWeekDays();
        const todayStr = new Date().toISOString().split('T')[0];
        tbody.innerHTML = habits.map(h => `
            <tr>
                <td style="font-weight:bold">${h.name}</td>
                ${weekDays.map(d => `<td class="${d === todayStr ? 'today-col' : ''}">${(logs[d] && logs[d][h.name]) ? 'â­<br>('+logs[d][h.name]+')' : '-'}</td>`).join('')}
            </tr>
        `).join('');

        // åˆ·æ–°éŠ€è¡Œåˆ—è¡¨
        document.getElementById('bankList').innerHTML = habitBank.map((h, i) => `
            <div class="bank-item">
                <span>${h.name} (${h.points}åˆ†)</span>
                <span onclick="removeFromBank(${i})" style="color:#ff7675;cursor:pointer;">åˆªé™¤</span>
            </div>
        `).join('');
    }

    function getCurrWeekDays() {
        const curr = new Date();
        const first = curr.getDate() - (curr.getDay() === 0 ? 6 : curr.getDay() - 1);
        return [...Array(7).keys()].map(i => new Date(new Date().setDate(first + i)).toISOString().split('T')[0]);
    }

    function removeHabit(i) { habits.splice(i, 1); save(); updateDisplay(); }
    function removeFromBank(i) { habitBank.splice(i, 1); save(); updateDisplay(); }
    function toggleAdmin() { const p = document.getElementById('adminPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function undoLastAction() { if(stats.weekCount > 0){ stats.totalWallet -= stats.lastPoints; stats.weekCount -= 1; save(); updateDisplay(); playSound(300, 150); } }
    function redeemPoints() { const c = prompt("æ‰£é™¤å¤šå°‘åˆ†ï¼Ÿ"); if(c && stats.totalWallet >= c){ stats.totalWallet -= c; playSound(800, 1200); save(); updateDisplay(); } }
    function resetWeeklyOnly() { if(confirm("ç¢ºå®šæ­¸é›¶æœ¬é€±æ•¸æ“šï¼Ÿç´€éŒ„å°‡æ¶ˆå¤±ã€‚")){ stats.weekStars = 0; stats.weekCount = 0; logs = {}; save(); updateDisplay(); } }
    function fullReset() { if(confirm("é€™æœƒæ¸…ç©ºåŒ…å«ã€ä»»å‹™éŠ€è¡Œã€åœ¨å…§çš„æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")){ localStorage.clear(); location.reload(); } }

    updateDisplay();
</script>
</body>
</html>